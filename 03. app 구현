ui <- fluidPage(
  titlePanel("마커 클릭 정보 표시"),
  sidebarLayout(
    sidebarPanel(
      selectInput("category", "유형 선택", 
                  choices = unique(ddm_data$대분류), selected = unique(ddm_data$대분류)[1]),
      verbatimTextOutput("info")  # 선택한 장소 정보를 표시
    ),
    mainPanel(
      tabsetPanel(
        tabPanel("지도",
                 leafletOutput("map", width = "100%", height = "500px")
        )
      )
    )
  )
)

server <- function(input, output, session) {
  
  # 선택한 유형에 따라 데이터 필터링
  filtered_data <- reactive({
    ddm_data %>% filter(대분류 == input$category)
  })
  
  # 지도 렌더링
  output$map <- renderLeaflet({
    leaflet() %>%
      addTiles()
  })
  
  # 유형 선택 시 지도 업데이트
  observe({
    data <- filtered_data()
    leafletProxy("map") %>%
      clearMarkers() %>%
      setView(lng=127.03758, lat=37.58060, zoom=13) %>%
      addPulseMarkers(
        lng = ~경도, lat = ~위도, label = ~장소이름, layerId = ~장소이름, 
        data = data, icon = makePulseIcon())
  })
  
  # 마커 클릭 시 정보 표시
  observeEvent(input$map_marker_click, {
    click <- input$map_marker_click
    
    data <- filtered_data()
    
    # 클릭한 마커와 같은 장소 찾기
    selected_place <- data %>% filter(장소이름 == click$id)
    
    if (nrow(selected_place) > 0) {
      output$info <- renderText({
        paste0("장소 이름: ", selected_place$장소이름)
      })
    }
  })
}

shinyApp(ui, server)
